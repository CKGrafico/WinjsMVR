/*
    WinJS MVR a simple library to do better and easy apps in Windows 8 with WinJS
    Inspired in Backbone but more simple and oriented to WinJS
    author: @CKGrafico
    version: beta-0.9
*/
(function(global,$,_){'use strict';var networkInfo=Windows.Networking.Connectivity.NetworkInformation;var networkConnectivityInfo=Windows.Networking.Connectivity.NetworkConnectivityLevel;var Base=WinJS.Class.define(function(){},{baseConstructor:function(context){var self=context;_.each(self.events,function(value,key){var split=key.split('/');var event;if(split.length===2){var object=split[0];event=split[1];if(self[value]){self[object].on(event,self[value],self)}else{debugger;console.log(self[value])}}else{event=key;if(self[value]){self.on(event,self[value],self)}else{debugger;console.log(self[value])}}})},options:{},events:{},initialize:function(){},trigger:function(event,options){this.dispatchEvent(event,options)},on:function(event,callback,context){this.addEventListener(event,_.bind(callback,context||this))},off:function(event,callback,context){WinJS.Application.removeEventListener(event,_.bind(callback,context||this))},once:function(event,callback,context){var self=this;this.on(event,function(){_.bind(callback,context||self);self.off()})},});WinJS.Class.mix(Base,WinJS.Utilities.eventMixin);var View=WinJS.Class.derive(Base,function(options){this.customConstructor(options)},{customConstructor:function(options){_.extend(this.options,options);if(this.model){var Model=this.model;this.model=new Model()}this.$el=$('<'+this.tagName+'/>').addClass(this.className).attr('id',this.idName);this.el=this.$el[0];var self=this;_.each(this.domEvents,function(value,key){var split=key.split(' ');var event=split[0];var element=split[1]||'';var method;if(self[value]){method=_.bind(self[value],self)}else{debugger;console.log(self[value])}var id=self.$el.attr('id');var tag=self.$el.prop('tagName').toLowerCase();element=(id)?tag+'#'+id+' '+element:tag+element;$('body').on(event,element,method)});this.initialize();this.baseConstructor(this)},tagName:'div',className:'',idName:'view',templatesPath:'/templates/',templatesExtension:'.hbs',templateName:null,template:function(moreOptions){if(this.templateName){return $('<div/>').loadFromTemplate({template:this.templateName,path:this.templatesPath,extension:this.templatesExtension,data:_.extend({},moreOptions,this.options)}).html()}},dom:{},classes:{},events:{},domEvents:{},model:null,render:function(){return this}});var Model=WinJS.Class.derive(Base,function(options){this.customConstructor(options)},{customConstructor:function(options){this.collection=[];_.extend(this.options,options);this.set('url',this.options.url||this.get('url')||null);this.baseConstructor(this);this.initialize()},attributes:{},get:function(attribute){if(!attribute){return this.attributes}else{return this.attributes[attribute]||null}},set:function(attribute,value){this.attributes[attribute]=value},toString:function(){return JSON.stringify(this.attributes)},collection:null,getJSON:function(data,callback){var self=this;var myUrl=this.get('url');if(myUrl){$.ajax({url:myUrl,async:data.async||false,data:data||{}}).done(function(results){var json;if(typeof(results)==='string'){json=$.parseJSON(results)}else{json=results}if(typeof(json)==='object'){var json_array;for(json_array in json){break}json=json[json_array]}_.each(json,self.addToCollection,self);self.trigger('collection.Fill',json);if(callback){callback(results)}})}},addToCollection:function(element){var newId=this.collection.length;element=_.extend(element,{_id:newId});this.collection.push(element);this.trigger('collection.Add',element)},resetCollection:function(){this.collection=[];this.trigger('collection.Reset')}});var Router=WinJS.Class.derive(Base,function(options){_.extend(this.options,options);this.$wrapper=$(this.options.wrapper)||$('body');this.pages=this.options.pages||{};WinJS.Navigation.addEventListener("navigated",_.bind(this.onNavigate,this));this.baseConstructor(this);this.initialize()},{navigate:function(page){WinJS.Navigation.navigate(page)},history:function(){return WinJS.Navigation.history},location:function(){return WinJS.Navigation.location},back:function(distance,callback){WinJS.Navigation.back(distance).done(callback)},addPage:function(page,view){this.pages[page]=view},onNavigate:function(page){var pageName=page.detail.location;var CurrentPage=this.pages[pageName];var rendered=CurrentPage.render();this.$wrapper.html(rendered.$el)}});WinJS.Class.extend=function(baseClass,constructor,instanceMembers,staticMembers){if(typeof(constructor)==='object'){return WinJS.Class.derive(baseClass,function(options){this.customConstructor(options)},constructor,instanceMembers)}else{return WinJS.Class.derive(baseClass,constructor,instanceMembers,staticMembers)}};var Tools=WinJS.Class.define(function(){var $progress=$('<progress/>').css({'position':'absolute','width':'160px','height':'160px','padding':'40px','background':'rgba(0, 0, 0, 0.8)','color':'#FFF','margin':'-100px -100px 0 0','top':'50%','left':'50%','z-index':'1000','border-radius':'6px'}).addClass('win-ring win-large');this.$loading=$('<div/>').css({'position':'absolute','top':'0','left':'0','display':'none','height':'100%','width':'100%'}).html($progress);$('body').append(this.$loading)},{alert:function(options){var opciones={text:null,btn1:"Accept",btn2:null,callback1:null,callback2:null,time:100}_.extend(opciones,options);if(!ShowingMessage){ShowingMessage=true;this.toggleLoading('fade')setTimeout(function(){var msg=new Windows.UI.Popups.MessageDialog(opciones.text);msg.commands.append(new Windows.UI.Popups.UICommand(opciones.btn1,opciones.callback1))if(opciones.btn2){msg.commands.append(new Windows.UI.Popups.UICommand(opciones.btn2,opciones.callback2))}this.toggleLoading('fade')msg.showAsync().done(function(){ShowingMessage=false})},opciones.time)}},haveInternet:function(){var connectionProfile=networkInfo.getInternetConnectionProfile();if(connectionProfile==null){return false}var networkConnectivityLevel=connectionProfile.getNetworkConnectivityLevel();if(networkConnectivityLevel==networkConnectivityInfo.none||networkConnectivityLevel==networkConnectivityInfo.localAccess||networkConnectivityLevel==networkConnectivityInfo.constrainedInternetAccess){return false}return true},internetMessage:function(){if($("#nointernet").length==0){$("body").prepend("<div id='nointernet' style='position: absolute;width: 100%;height: 100%;background: rgba(255,255,255,0.6);z-index: 100000;font-weight: bold;text-align: center;color: rgba(0,0,0,0.4);font-size: 6em;'>No Internet</div>")}if(this.haveInternet()){$("#nointernet").remove()}},needInternetAction:function(options){var opciones={callback:null,param:null}_.extend(opciones,options);if(this.haveInternet()){if(opciones.callback){if(opciones.param){opciones.callback(opciones.param)}else{opciones.callback()}}}else{this.internetMessage();var self=this;setTimeout(function(){self.needInternetAction(opciones)},100)}},toggleLoading:function(extra){if(extra){this.$loading.fadeToggle()}else{this.$loading.toggle()}}});var tools=new Tools();WinJS.Namespace.define("WinjsMVR",{View:View,Model:Model,Router:Router,Tools:tools})})(window,jQuery,_);